name: 'Cromwell unit tests'

#This github action runs all of Cromwell's unit tests.
#A matrix strategy is used so that each subproject can be unit tested in parallel with all other subprojects. 

#This is what shows up in the github workflows page as the title. 
run-name: ${{ github.actor }} running Cromwell sbt unit tests.

#What will trigger the workflow to run. 
on:
  workflow_dispatch: #Manual trigger from GitHub UI
  push:
  pull_request: 

permissions: 
  contents: read

jobs:
  generate-subproject-matrix: #This job will invoke SBT to get a list of all subprojects in Cromwell. Later, this list will be used to teach each subproject in parallel.
    name: Get sbt subprojects
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3 # required first to checkout the repo
    - uses: ./.github/set_up_cromwell_action
      with:
        cromwell_repo_token: ${{ secrets.BROADBOT_GITHUB_TOKEN }}

      #Parse the sbt-generated list of projects into a YAML array. Note that we strip
      #invisible color codes out of the `sbt projects` output.
    - name: Do the thing
      run: |
        echo "SBT_PROJECTS=$(sbt projects | sed 's/\x1b\[[0-9;]*m//g' | sed -e 's/^\[info\]\s*\([-_A-Za-z0-9]*\)$/\1/g' | grep -v '^\[info\].*' | tr '\n', ',' | sed 's/^/[/' | sed 's/.$/]\n/')" >> $GITHUB_ENV

    - name: Test the thing
        run: |
        echo ${{ env.SBT_PROJECTS }}

    outputs:
      subproject-matrix: ${{ env.SBT_PROJECTS }}

  build-and-test: 
    needs: generate-subproject-matrix
    strategy:
      fail-fast: false #Disabling fail fast means that even if one job in the matrix fails, the others will still try to complete.
      matrix: #this array is the output of the command `sbt projects` from the cromwell root directory, minus a bunch of superflous formatting that sbt adds.
        sbtSubProject: ${{ needs.generate-subproject-matrix.outputs.subproject-matrix }}

    #This action is using a Github free runner, rather than a Broad self-hosted one. This is because the Broad ones don't have sbt installed by default.
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3 # required first to checkout the repo
    - uses: ./.github/set_up_cromwell_action
      with:
        cromwell_repo_token: ${{ secrets.BROADBOT_GITHUB_TOKEN }}

    #Parse the sbt-generated list of projects into a YAML array. Note that we strip
    #invisible color codes out of the `sbt projects` output.
    - name: Do the thing
      run: |
        echo "SBT_PROJECTS=$(sbt projects | sed 's/\x1b\[[0-9;]*m//g' | sed -e 's/^\[info\]\s*\([-_A-Za-z0-9]*\)$/\1/g' | grep -v '^\[info\].*' | tr '\n', ',' | sed 's/^/[/' | sed 's/.$/]\n/')" >> $GITHUB_ENV

    #Invoke SBT on a specific subproject, asking it to run all unit tests contained within that subproject.
    - name: Run tests
      run: |
        set -e
        sbt "${{ matrix.sbtSubProject }}/test"