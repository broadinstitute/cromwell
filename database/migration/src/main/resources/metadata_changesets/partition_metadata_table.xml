<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog objectQuotingStrategy="QUOTE_ALL_OBJECTS"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet id="update_indexes_metadata_table" author="cahrens" dbms="mysql,postgresql,hsqldb,mariadb">
        <comment>Updates indexes on the METADATA_ENTRY table</comment>
        <createIndex indexName="METADATA_ENTRY_UUID_KEY_CALL_INDEX_ATTEMPT_INDEX" tableName="METADATA_ENTRY">
            <column name="WORKFLOW_EXECUTION_UUID"/>
            <column name="CALL_FQN"/>
            <column name="JOB_SCATTER_INDEX"/>
            <column name="JOB_RETRY_ATTEMPT"/>
            <column name="METADATA_KEY"/>
        </createIndex>
        <createIndex indexName="METADATA_ENTRY_UUID_KEY" tableName="METADATA_ENTRY">
            <column name="WORKFLOW_EXECUTION_UUID"/>
            <column name="METADATA_KEY"/>
        </createIndex>
        <dropIndex tableName="METADATA_ENTRY" indexName="METADATA_WORKFLOW_IDX"/>
    </changeSet>
    <changeSet id="compress_and_partition_metadata_table" author="cahrens" dbms="mysql">
        <!-- Do not run this migration in Terra, where we will have already done the migration/table swap -->
        <preConditions onFail="MARK_RAN">
            <!-- If we have already run the migration, the primary key will be composite (count 2) -->
            <sqlCheck expectedResult="1">
                SELECT COUNT(COLUMN_NAME)
                FROM information_schema.KEY_COLUMN_USAGE
                WHERE TABLE_NAME = 'METADATA_ENTRY'
                AND CONSTRAINT_NAME = 'PRIMARY'
            </sqlCheck>
        </preConditions>
        <comment>Partition and compress the METADATA_ENTRY table (mysqldb only)</comment>
        <sql>
            alter table METADATA_ENTRY ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=8,
            drop primary key, add primary key(METADATA_JOURNAL_ID, WORKFLOW_EXECUTION_UUID)
            PARTITION BY RANGE COLUMNS(WORKFLOW_EXECUTION_UUID) (
              partition p0 values less than ('1'),
              partition p1 values less than ('2'),
              partition p2 values less than ('3'),
              partition p3 values less than ('4'),
              partition p4 values less than ('5'),
              partition p5 values less than ('6'),
              partition p6 values less than ('7'),
              partition p7 values less than ('8'),
              partition p8 values less than ('9'),
              partition p9 values less than ('a'),
              partition pa values less than ('b'),
              partition pb values less than ('c'),
              partition pc values less than ('d'),
              partition pd values less than ('e'),
              partition pe values less than ('f'),
              partition pf values less than MAXVALUE);
        </sql>
    </changeSet>
    <changeSet id="update_primary_key_mariadb" author="cahrens" dbms="mariadb">
        <comment>Update the primary key (mariadb)</comment>
        <!-- Cannot run as 2 independent steps: "there can be only one auto column and it must be defined as a key" -->
        <sql>
            alter table METADATA_ENTRY
            drop primary key, add primary key(METADATA_JOURNAL_ID, WORKFLOW_EXECUTION_UUID);
        </sql>
    </changeSet>
    <changeSet id="update_primary_key_hsqldb" author="cahrens" dbms="hsqldb">
        <comment>Update the primary key (hsqldb)</comment>
        <dropPrimaryKey tableName="METADATA_ENTRY"/>
        <addPrimaryKey tableName="METADATA_ENTRY" columnNames="METADATA_JOURNAL_ID, WORKFLOW_EXECUTION_UUID"
                       constraintName="PK_METADATA_ENTRY"/>
    </changeSet>
    <changeSet id="update_primary_key_postgresql" author="cahrens" dbms="postgresql">
        <comment>Update the primary key (postgresql)</comment>
        <dropPrimaryKey tableName="METADATA_ENTRY"/>
<!--        <sql>-->
<!--            alter table "public"."METADATA_ENTRY" drop constraint METADATA_ENTRY_PKEY;-->
<!--        </sql>-->
        <addPrimaryKey tableName="METADATA_ENTRY" columnNames="METADATA_JOURNAL_ID, WORKFLOW_EXECUTION_UUID"
                       constraintName="PK_METADATA_ENTRY"/>
    </changeSet>
</databaseChangeLog>

<!--        Where: SQL statement "alter table "public"."METADATA_ENTRY" drop constraint PK_METADATA_JOURNAL"-->
<!--        PL/pgSQL function inline_code_block line 7 at EXECUTE [Failed SQL: DO $$ DECLARE constraint_name varchar;-->
<!--        BEGIN-->
<!--        SELECT tc.CONSTRAINT_NAME into strict constraint_name-->
<!--        FROM INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc-->
<!--        WHERE CONSTRAINT_TYPE = 'PRIMARY KEY'-->
<!--        AND TABLE_NAME = 'METADATA_ENTRY' AND TABLE_SCHEMA = 'public';-->
<!--        EXECUTE 'alter table "public"."METADATA_ENTRY" drop constraint ' || constraint_name;-->
<!--        END $$;]-->