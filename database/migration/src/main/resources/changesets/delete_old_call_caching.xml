<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet id="delete_old_call_caching" author="lmcnatt" dbms="mysql,hsqldb">
                <sql  splitStatements="false" endDelimiter="$$">
                    <![CDATA[
                        CREATE EVENT IF NOT EXISTS delete_old_call_cache_entries
                            ON SCHEDULE EVERY 1 DAY
                            DO
                            BEGIN
                                -- Delete from child tables in one statement
                                DELETE h, s, d, a
                                FROM CALL_CACHING_ENTRY main
                                LEFT JOIN CALL_CACHING_HASH_ENTRY h ON h.CALL_CACHING_ENTRY_ID = main.CALL_CACHING_ENTRY_ID
                                LEFT JOIN CALL_CACHING_SIMPLETON_ENTRY s ON s.CALL_CACHING_ENTRY_ID = main.CALL_CACHING_ENTRY_ID
                                LEFT JOIN CALL_CACHING_DETRITUS_ENTRY d ON d.CALL_CACHING_ENTRY_ID = main.CALL_CACHING_ENTRY_ID
                                LEFT JOIN CALL_CACHING_AGGREGATION_ENTRY a ON a.CALL_CACHING_ENTRY_ID = main.CALL_CACHING_ENTRY_ID
                                WHERE main.CREATED_AT < (NOW() - INTERVAL 90 DAY);

                                -- delete from the main entry table last to avoid foreign key constraint violations
                                DELETE FROM CALL_CACHING_ENTRY
                                WHERE CREATED_AT < (NOW() - INTERVAL 90 DAY);
                            END
                    ]]>
                </sql>
    </changeSet>
</databaseChangeLog>