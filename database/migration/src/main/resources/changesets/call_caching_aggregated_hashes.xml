<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet author="tjeandet" id="call_caching_aggregation_entry">
        <comment>
            Holds an aggregated version of the hashes for each cache entry.
            Split into "BaseAggregation" and "InputFilesAggregation"
            BaseAggregation aggregates all call hashes, except input files.
            It should be used as a first pass to check if cache hits exist.
            InputFiles aggregates all hashes from the input files of a call. 
            It should be used as a second pass to check if cache hits exist, only if the first pass succeeded.
        </comment>
        <createTable tableName="CALL_CACHING_AGGREGATION_ENTRY">
            <column autoIncrement="true" name="CALL_CACHING_AGGREGATION_ENTRY_ID" type="INT">
                <constraints primaryKey="true" primaryKeyName="PK_CALL_CACHING_AGGREGATION_ENTRY"/>
            </column>
            <column name="CALL_CACHING_ENTRY_ID" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="BASE_AGGREGATION" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="INPUT_FILES_AGGREGATION" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="tjeandet" id="call_caching_aggregation_entry_keys_and_indexes">
        <addForeignKeyConstraint baseColumnNames="CALL_CACHING_ENTRY_ID"
                                 baseTableName="CALL_CACHING_AGGREGATION_ENTRY"
                                 constraintName="FK_CALL_CACHING_AGGREGATION_ENTRY_CALL_CACHING_ENTRY_ID"
                                 referencedColumnNames="CALL_CACHING_ENTRY_ID"
                                 referencedTableName="CALL_CACHING_ENTRY"/>
        <createIndex indexName="IX_CALL_CACHING_AGGREGATION_ENTRY_BA_IFA"
                     tableName="CALL_CACHING_AGGREGATION_ENTRY"
                     unique="false">
            <column name="BASE_AGGREGATION"/>
            <column name="INPUT_FILES_AGGREGATION"/>
        </createIndex>
    </changeSet>

    <changeSet author="tjeandet" id="call_caching_aggregation_entry_base_aggregation" dbms="mysql">
        <sqlFile relativeToChangelogFile="true" path="call_caching_aggregation/call_caching_base_aggregation.sql" />
    </changeSet>
    
    <changeSet author="tjeandet" id="call_caching_aggregation_entry_input_files_aggregation" dbms="mysql">
        <sqlFile relativeToChangelogFile="true" path="call_caching_aggregation/call_caching_input_files_aggregation.sql" />
    </changeSet>
</databaseChangeLog>
