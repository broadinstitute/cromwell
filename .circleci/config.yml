version: 2.1

orbs:
  slack: circleci/slack@4.2.1

commands:
  install-adoptopenjdk:
    description: "Installing adoptopenjdk 8 and setting it as default Java"
    steps:
      - run: wget -qO - https://adoptopenjdk.jfrog.io/adoptopenjdk/api/gpg/key/public | sudo apt-key add -
      - run: sudo add-apt-repository --yes https://adoptopenjdk.jfrog.io/adoptopenjdk/deb/
      - run: sudo apt update
      - run: sudo apt install adoptopenjdk-8-hotspot
      - run: sudo update-java-alternatives --set adoptopenjdk-8-hotspot-amd64

jobs:
  test:
    machine:
      image: ubuntu-2004:202010-01
    resource_class: large
    parameters:
      build-type:
        type: string
      build-mysql:
        type: string
        default: ""
      build-mariadb:
        type: string
        default: ""
      build-postgresql:
        type: string
        default: ""
    steps:
      - install-adoptopenjdk
      - run: git clone "$CIRCLE_REPOSITORY_URL" --branch "$CIRCLE_BRANCH" . # clone to working dir not `cromwell/`
      - run:
          command: src/ci/bin/test.sh
          no_output_timeout: 1h
    environment:
      CIRCLE_COMMIT_RANGE: << pipeline.git.base_revision >>...<< pipeline.git.revision >>
      BUILD_TYPE: << parameters.build-type >>
      BUILD_MYSQL: << parameters.build-mysql >>
      BUILD_MARIADB: << parameters.build-mariadb >>
      BUILD_POSTGRESQL: << parameters.build-postgresql >>

workflows:
  all-tests:
    jobs:
      - test:
          name: testSbt
          build-type: "sbt"
      - test:
          name: testSingleWorkflowRunner
          build-type: "singleWorkflowRunner"
      - test:
          name: testDbms
          build-type: "dbms"
      - test:
          name: testHoricromtalDeadlock
          build-type: "horicromtalDeadlock"
      - test:
          name: testDockerScripts
          build-type: "dockerScripts"
      - test:
          name: testReferenceDiskManifestBuilderApp
          build-type: "referenceDiskManifestBuilderApp"
